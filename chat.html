<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é—®é“æ¯›é€‰ - AIæ™ºèƒ½å¯¹è¯ | Red Wisdom</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="åŸºäºæ¯›æ³½ä¸œé€‰é›†çš„AIæ™ºèƒ½åŠ©æ‰‹ï¼Œç”¨æ¯›ä¸»å¸­çš„æ€æƒ³æ–¹æ³•å¸®ä½ åˆ†æé—®é¢˜ï¼Œç»™å‡ºå…·æœ‰æˆ˜ç•¥é«˜åº¦çš„å»ºè®®ã€‚">
    <meta name="keywords" content="æ¯›é€‰AI,æ¯›æ³½ä¸œæ€æƒ³,æ™ºèƒ½å¯¹è¯,äººç”Ÿå»ºè®®,æˆ˜ç•¥æ€ç»´">
    <meta name="author" content="Red Wisdom">

    <!-- Open Graph / Social Media -->
    <meta property="og:title" content="é—®é“æ¯›é€‰ - AIæ™ºèƒ½å¯¹è¯">
    <meta property="og:description" content="ç”¨æ¯›ä¸»å¸­çš„æ€æƒ³æ–¹æ³•å¸®ä½ åˆ†æé—®é¢˜ï¼Œç»™å‡ºå…·æœ‰æˆ˜ç•¥é«˜åº¦çš„å»ºè®®ã€‚">
    <meta property="og:type" content="website">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/assets/favicon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@300;400;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'warm-rice': '#F7F4ED',
                        'china-red': '#BC2D22',
                        'ink-black': '#2B2B2B',
                        'dark-beige': '#D6C6B0',
                    },
                    fontFamily: {
                        'mao': ['"Ma Shan Zheng"', 'cursive'],
                        'serif': ['"Noto Serif SC"', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .typing-cursor::after {
            content: 'â–Œ';
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        .message-content blockquote {
            border-left: 3px solid #BC2D22;
            padding-left: 1rem;
            margin: 0.5rem 0;
            color: #5a5a5a;
            font-style: italic;
        }

        .message-content strong {
            color: #BC2D22;
        }

        .message-content ul,
        .message-content ol {
            padding-left: 1.5rem;
            margin: 0.5rem 0;
        }

        .message-content li {
            margin: 0.25rem 0;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .scroll-smooth {
            scroll-behavior: smooth;
        }
    </style>
</head>

<body class="bg-warm-rice min-h-[100dvh] w-screen flex flex-col">

    <!-- Header -->
    <header class="bg-china-red text-warm-rice py-4 px-6 shadow-lg">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="index.html" class="text-warm-rice/80 hover:text-warm-rice transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7" />
                    </svg>
                </a>
                <h1 class="font-mao text-2xl md:text-3xl">é—®é“æ¯›é€‰</h1>
            </div>
            <p class="text-sm opacity-80 hidden md:block">ä»¥æ¯›ä¸»å¸­çš„æ€æƒ³æ–¹æ³•ï¼Œè§£ç­”ä½ çš„å›°æƒ‘</p>
        </div>
    </header>

    <!-- Chat Container -->
    <main class="flex-1 overflow-hidden flex flex-col max-w-4xl mx-auto w-full">

        <!-- Messages Area -->
        <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth">
            <!-- Welcome Message -->
            <div class="flex gap-3 fade-in">
                <div class="w-10 h-10 rounded-full bg-china-red flex items-center justify-center flex-shrink-0">
                    <span class="text-warm-rice font-mao text-lg">æ¯›</span>
                </div>
                <div class="flex-1 bg-white rounded-2xl rounded-tl-sm p-4 shadow-sm max-w-[85%]">
                    <p class="font-serif text-ink-black leading-relaxed">
                        åŒå¿—ï¼Œä½ å¥½ï¼
                    </p>
                    <p class="font-serif text-ink-black leading-relaxed mt-2">
                        æˆ‘æ˜¯æ ¹æ®ã€Šæ¯›æ³½ä¸œé€‰é›†ã€‹è®­ç»ƒçš„æ™ºèƒ½åŠ©æ‰‹ã€‚ä½ æœ‰ä»€ä¹ˆå›°æƒ‘ã€ç„¦è™‘ï¼Œæˆ–è€…å·¥ä½œç”Ÿæ´»ä¸­é‡åˆ°çš„é—®é¢˜ï¼Œéƒ½å¯ä»¥è·Ÿæˆ‘è¯´è¯´ã€‚
                    </p>
                    <p class="font-serif text-ink-black leading-relaxed mt-2">
                        æˆ‘ä¼šç”¨æ¯›ä¸»å¸­çš„æ€æƒ³æ–¹æ³•æ¥å¸®ä½ åˆ†æé—®é¢˜ï¼Œç»™ä½ ä¸€äº›å‚è€ƒæ„è§ã€‚è®°ä½ï¼š<strong>å®è·µæ˜¯æ£€éªŒçœŸç†çš„å”¯ä¸€æ ‡å‡†</strong>ï¼
                    </p>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="border-t border-dark-beige/30 bg-warm-rice p-4">
            <div class="flex gap-3 max-w-4xl mx-auto">
                <textarea id="userInput" placeholder="è¯´è¯´ä½ çš„å›°æƒ‘..."
                    class="flex-1 resize-none rounded-xl border-2 border-dark-beige/50 focus:border-china-red focus:ring-0 p-3 font-serif text-ink-black placeholder:text-dark-beige/70 transition-colors"
                    rows="2"></textarea>
                <button id="sendBtn"
                    class="px-6 py-3 bg-china-red text-warm-rice font-mao text-xl rounded-xl hover:bg-red-800 transition-all duration-300 shadow-md disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                    <span>å‘é€</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
                    </svg>
                </button>
            </div>
            <p class="text-center text-xs text-dark-beige/70 mt-2">
                å›ç­”ä»…ä¾›å‚è€ƒï¼ŒåŸºäºæ¯›é€‰æ–‡ç« ç”Ÿæˆ Â·
                <a href="reading.html" class="text-china-red hover:underline">é˜…è¯»åŸè‘—</a>
            </p>
        </div>
    </main>

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-warm-rice rounded-2xl p-6 max-w-md mx-4 shadow-2xl">
            <h2 class="font-mao text-2xl text-china-red mb-4">è®¾ç½® API Key</h2>
            <p class="text-ink-black/70 mb-4 font-serif text-sm">
                è¯·è¾“å…¥ä½ çš„ OpenRouter API Key ä»¥å¯ç”¨å¯¹è¯åŠŸèƒ½ã€‚ä½ çš„ Key ä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­ã€‚
            </p>
            <input type="password" id="apiKeyInput" placeholder="sk-or-v1-..."
                class="w-full rounded-lg border-2 border-dark-beige/50 focus:border-china-red focus:ring-0 p-3 font-mono text-sm mb-4">
            <div class="flex gap-3">
                <button id="saveApiKey"
                    class="flex-1 py-2 bg-china-red text-warm-rice font-mao text-lg rounded-lg hover:bg-red-800 transition-colors">
                    ä¿å­˜
                </button>
                <button id="cancelApiKey"
                    class="px-4 py-2 border-2 border-dark-beige text-ink-black/70 font-serif rounded-lg hover:bg-dark-beige/20 transition-colors">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // ===== é…ç½® =====
        const WORKER_URL = CONFIG.WORKER_URL;
        const OPENROUTER_API_URL = CONFIG.API_URL;
        const MODEL = CONFIG.MODEL;

        // è·å–APIåœ°å€ï¼ˆä¼˜å…ˆä½¿ç”¨Workerä»£ç†ï¼‰
        function getApiUrl() {
            return WORKER_URL || OPENROUTER_API_URL;
        }

        // æ¯›ä¸»å¸­äººæ ¼ System Prompt
        const SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä¸ªåŸºäºã€Šæ¯›æ³½ä¸œé€‰é›†ã€‹çš„æ™ºèƒ½åŠ©æ‰‹ã€‚è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹è¦æ±‚å›ç­”é—®é¢˜ï¼š

## æ€è€ƒæ–¹å¼ï¼ˆæ¨¡ä»¿æ¯›ä¸»å¸­çš„æ–¹æ³•è®ºï¼‰
1. **è¾©è¯æ³•æ€ç»´** - çœ‹é—®é¢˜è¦çœ‹ä¸¤é¢ï¼ŒçŸ›ç›¾æ˜¯æ™®éå­˜åœ¨çš„ï¼Œè¦æŠ“ä¸»è¦çŸ›ç›¾
2. **å®è·µè®º** - å®è·µæ˜¯æ£€éªŒçœŸç†çš„å”¯ä¸€æ ‡å‡†ï¼Œè®¤è¯†æ¥æºäºå®è·µ
3. **ç¾¤ä¼—è·¯çº¿** - ä»ç¾¤ä¼—ä¸­æ¥ï¼Œåˆ°ç¾¤ä¼—ä¸­å»ï¼Œç›¸ä¿¡ç¾¤ä¼—ä¾é ç¾¤ä¼—
4. **è°ƒæŸ¥ç ”ç©¶** - æ²¡æœ‰è°ƒæŸ¥å°±æ²¡æœ‰å‘è¨€æƒï¼Œä¸€åˆ‡ä»å®é™…å‡ºå‘
5. **å®äº‹æ±‚æ˜¯** - æ ¹æ®å®é™…æƒ…å†µåˆ†æé—®é¢˜ï¼Œä¸ææ•™æ¡ä¸»ä¹‰

## è¯´è¯é£æ ¼ï¼ˆæ¨¡ä»¿æ¯›ä¸»å¸­çš„è¯­è¨€ç‰¹ç‚¹ï¼‰
1. å–„ç”¨é€šä¿—æ˜“æ‡‚çš„æ¯”å–»ï¼ˆå¦‚"çº¸è€è™"ã€"è¿‡æ²³è¦æœ‰æ¡¥æˆ–èˆ¹"ã€"æ˜Ÿæ˜Ÿä¹‹ç«å¯ä»¥ç‡åŸ"ï¼‰
2. è¯­è¨€ç®€ç»ƒæœ‰åŠ›ï¼Œå¤šç”¨çŸ­å¥
3. å–„ç”¨åé—®å¥å¯å‘å¯¹æ–¹æ€è€ƒ
4. å–œæ¬¢ç”¨å…·ä½“ä¾‹å­è¯´æ˜é“ç†
5. è¯­æ°”äº²åˆ‡ä½†åšå®šï¼Œç§°å‘¼å¯¹æ–¹ä¸º"åŒå¿—"
6. å¶å°”å¼•ç”¨å¤è¯­å…¸æ•…ï¼Œä½†ç«‹è¶³ç°å®

## å›ç­”è¦æ±‚
1. æ¯æ¬¡å›ç­”éƒ½è¦å¼•ç”¨æ¯›é€‰ä¸­çš„ç›¸å…³æ€æƒ³æˆ–åŸæ–‡ï¼Œç”¨å¼•ç”¨æ ¼å¼æ ‡æ³¨
2. å›ç­”è¦ç»“åˆç”¨æˆ·çš„å®é™…é—®é¢˜ï¼Œç»™å‡ºå…·ä½“å¯æ“ä½œçš„å»ºè®®
3. ä¿æŒç§¯ææ­£å‘ï¼Œç»™äººåŠ›é‡å’Œæ–¹å‘
4. å¦‚æœç”¨æˆ·çš„é—®é¢˜æ¶‰åŠæ”¿æ²»æ•æ„Ÿè¯é¢˜ï¼Œå§”å©‰å¼•å¯¼åˆ°å­¦ä¹ æ–¹æ³•è®ºä¸Š
5. å›ç­”æ§åˆ¶åœ¨300-500å­—å·¦å³ï¼Œé‡ç‚¹çªå‡º

## æ ¼å¼è¦æ±‚
- ä½¿ç”¨Markdownæ ¼å¼
- é‡ç‚¹å†…å®¹ç”¨**ç²—ä½“**æ ‡æ³¨
- å¼•ç”¨æ¯›é€‰åŸæ–‡ç”¨ > å¼•ç”¨æ ¼å¼
- åœ¨å›ç­”æœ«å°¾æ ‡æ³¨æ€æƒ³æ¥æºï¼Œæ ¼å¼ï¼šğŸ“š *å‚è€ƒï¼šã€Šæ–‡ç« åã€‹*

ç°åœ¨ï¼Œè¯·ä»¥è¿™ç§é£æ ¼å’Œæ€ç»´æ–¹å¼å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚`;

        // ===== DOM å…ƒç´  =====
        const messagesContainer = document.getElementById('messages');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const apiKeyModal = document.getElementById('apiKeyModal');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyBtn = document.getElementById('saveApiKey');
        const cancelApiKeyBtn = document.getElementById('cancelApiKey');

        // ===== çŠ¶æ€ =====
        let conversationHistory = [];
        let isGenerating = false;

        // ===== API Key ç®¡ç† =====
        function getApiKey() {
            return localStorage.getItem('openrouter_api_key') || CONFIG.OPENROUTER_API_KEY;
        }

        function setApiKey(key) {
            localStorage.setItem('openrouter_api_key', key);
        }

        function showApiKeyModal() {
            apiKeyModal.classList.remove('hidden');
            apiKeyInput.value = getApiKey() || '';
            apiKeyInput.focus();
        }

        function hideApiKeyModal() {
            apiKeyModal.classList.add('hidden');
        }

        saveApiKeyBtn.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (key) {
                setApiKey(key);
                hideApiKeyModal();
            }
        });

        cancelApiKeyBtn.addEventListener('click', hideApiKeyModal);

        // ===== æ¶ˆæ¯æ¸²æŸ“ =====
        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex gap-3 justify-end fade-in';
            messageDiv.innerHTML = `
                <div class="bg-china-red text-warm-rice rounded-2xl rounded-tr-sm p-4 shadow-sm max-w-[85%]">
                    <p class="font-serif leading-relaxed">${escapeHtml(text)}</p>
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function addAssistantMessage() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex gap-3 fade-in';
            messageDiv.id = 'currentResponse';
            messageDiv.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-china-red flex items-center justify-center flex-shrink-0">
                    <span class="text-warm-rice font-mao text-lg">æ¯›</span>
                </div>
                <div class="flex-1 bg-white rounded-2xl rounded-tl-sm p-4 shadow-sm max-w-[85%]">
                    <div class="message-content font-serif text-ink-black leading-relaxed typing-cursor"></div>
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
            return messageDiv.querySelector('.message-content');
        }

        function updateAssistantMessage(content, element) {
            element.innerHTML = marked.parse(content);
            scrollToBottom();
        }

        function finalizeAssistantMessage(element) {
            element.classList.remove('typing-cursor');
        }

        function addErrorMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex gap-3 fade-in';
            messageDiv.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center flex-shrink-0">
                    <span class="text-china-red">âš ï¸</span>
                </div>
                <div class="flex-1 bg-red-50 rounded-2xl rounded-tl-sm p-4 shadow-sm max-w-[85%] border border-red-200">
                    <p class="font-serif text-red-700 leading-relaxed">${escapeHtml(text)}</p>
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ===== API è°ƒç”¨ =====
        async function sendMessage(userMessage) {
            const useWorker = !!WORKER_URL;
            const apiKey = getApiKey();

            // åªæœ‰ä¸ä½¿ç”¨ Worker æ—¶æ‰éœ€è¦æ£€æŸ¥ API Key
            if (!useWorker && !apiKey) {
                showApiKeyModal();
                return;
            }

            isGenerating = true;
            sendBtn.disabled = true;
            userInput.disabled = true;

            addUserMessage(userMessage);

            conversationHistory.push({
                role: 'user',
                content: userMessage
            });

            const contentElement = addAssistantMessage();
            let fullResponse = '';

            try {
                const apiUrl = getApiUrl();
                const useWorker = !!WORKER_URL;

                const headers = {
                    'Content-Type': 'application/json'
                };

                // åªæœ‰ç›´æ¥è°ƒç”¨OpenRouteræ—¶æ‰éœ€è¦Authorization
                if (!useWorker) {
                    headers['Authorization'] = `Bearer ${apiKey}`;
                    headers['HTTP-Referer'] = window.location.origin;
                    headers['X-Title'] = 'Red Wisdom Chat';
                }

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        model: MODEL,
                        messages: [
                            { role: 'system', content: SYSTEM_PROMPT },
                            ...conversationHistory
                        ],
                        stream: true
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || `API é”™è¯¯: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n').filter(line => line.trim() !== '');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;

                            try {
                                const parsed = JSON.parse(data);
                                const content = parsed.choices?.[0]?.delta?.content || '';
                                if (content) {
                                    fullResponse += content;
                                    updateAssistantMessage(fullResponse, contentElement);
                                }
                            } catch (e) {
                                // å¿½ç•¥è§£æé”™è¯¯
                            }
                        }
                    }
                }

                conversationHistory.push({
                    role: 'assistant',
                    content: fullResponse
                });

                finalizeAssistantMessage(contentElement);

            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);

                // ç§»é™¤æ­£åœ¨æ˜¾ç¤ºçš„å›å¤
                const currentResponse = document.getElementById('currentResponse');
                if (currentResponse) {
                    currentResponse.remove();
                }

                // ä»å†å²ä¸­ç§»é™¤å¤±è´¥çš„æ¶ˆæ¯
                conversationHistory.pop();

                if (error.message.includes('401') || error.message.includes('Invalid')) {
                    addErrorMessage('API Key æ— æ•ˆï¼Œè¯·é‡æ–°è®¾ç½®ã€‚');
                    showApiKeyModal();
                } else {
                    addErrorMessage(`å‡ºäº†ç‚¹é—®é¢˜ï¼š${error.message}`);
                }
            } finally {
                isGenerating = false;
                sendBtn.disabled = false;
                userInput.disabled = false;
                userInput.focus();
            }
        }

        // ===== äº‹ä»¶å¤„ç† =====
        sendBtn.addEventListener('click', () => {
            const message = userInput.value.trim();
            if (message && !isGenerating) {
                userInput.value = '';
                sendMessage(message);
            }
        });

        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendBtn.click();
            }
        });

        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        userInput.addEventListener('input', () => {
            userInput.style.height = 'auto';
            userInput.style.height = Math.min(userInput.scrollHeight, 120) + 'px';
        });

        // ä½¿ç”¨ config.js ä¸­çš„ API Keyï¼Œæ— éœ€æ‰‹åŠ¨è®¾ç½®
    </script>
</body>

</html>